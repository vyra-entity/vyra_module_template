[unix_http_server]
file=/tmp/supervisord.sock
chmod=0700

[supervisord]
nodaemon=true
logfile=/workspace/log/supervisord.log
pidfile=/var/run/supervisord.pid
user=root

[supervisorctl]
serverurl=unix:///tmp/supervisord.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:ros2_main]
command=bash tools/startup_ros2_node.sh
directory=/workspace
autostart=true
autorestart=false
priority=5
stdout_logfile=/workspace/log/ros2/ros2_stdout.log
stdout_logfile_format=%(ENV_LOGGING_FORMAT)s
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/workspace/log/ros2/ros2_stderr.log
stderr_logfile_format=%(ENV_LOGGING_FORMAT)s
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
environment=HOME="/root",USER="root",ROS_LOG_DIR="/workspace/log/ros2",LOGGING_FORMAT="%(ENV_LOGGING_FORMAT)s"

[program:uvicorn]
command=bash -c '\
    if [ -f "/workspace/src/asgi.py" ]; then \
        CERT="/workspace/storage/certificates/webserver.crt"; \
        KEY="/workspace/storage/certificates/webserver.key"; \
        if [ -f "$CERT" ] && [ -f "$KEY" ]; then \
            echo "üîí Starting Uvicorn with SSL/TLS enabled"; \
            exec uvicorn src.asgi:application --host 0.0.0.0 --port 8443 --ssl-certfile "$CERT" --ssl-keyfile "$KEY" --log-level info; \
        else \
            echo "‚ö†Ô∏è WARNING: SSL certificates not found at $CERT or $KEY"; \
            echo "‚ö†Ô∏è Starting Uvicorn in HTTP mode (insecure!)"; \
            echo "üí° Run: ./tools/create_ssl_certificates.sh --name webserver"; \
            exec uvicorn src.asgi:application --host 0.0.0.0 --port 8443 --log-level info; \
        fi; \
    else \
        echo "‚ùå ERROR: asgi.py not found in /workspace/src/"; \
        echo "üí° Create asgi.py or migrate your application to ASGI"; \
        sleep infinity; \
    fi'
directory=/workspace
autostart=false
autorestart=true
priority=10

stdout_logfile=/workspace/log/uvicorn/uvicorn_access.log
stdout_logfile_format=%(ENV_LOGGING_FORMAT)s
stdout_logfile_maxbytes=5MB
stdout_logfile_backups=5
stderr_logfile=/workspace/log/uvicorn/uvicorn_error.log
stderr_logfile_format=%(ENV_LOGGING_FORMAT)s
stderr_logfile_maxbytes=5MB
stderr_logfile_backups=5

[program:nginx]
command=/bin/bash -c '\
    if [ "$VYRA_DEV_MODE" = "false" ]; then \
        NGINX_CONF="/workspace/config/nginx.conf"; \
        if [ -f "$NGINX_CONF" ]; then \
            CERT="/workspace/storage/certificates/frontend.crt"; \
            KEY="/workspace/storage/certificates/frontend.key"; \
            if [ -f "$CERT" ] && [ -f "$KEY" ]; then \
                echo "üîí Starting Nginx with SSL/TLS enabled"; \
            else \
                echo "‚ö†Ô∏è WARNING: Frontend SSL certificates not found at $CERT or $KEY"; \
                echo "‚ö†Ô∏è Nginx may fail if SSL is configured in nginx.conf"; \
                echo "üí° Run: ./tools/create_ssl_certificates.sh --name frontend"; \
            fi; \
            /usr/sbin/nginx -c "$NGINX_CONF" -g "daemon off; pid /tmp/nginx_vyra.pid;"; \
        else \
            echo "‚ùå ERROR: nginx.conf not found at $NGINX_CONF"; \
            sleep infinity; \
        fi; \
    else \
        echo "‚è≠Ô∏è Nginx disabled (VYRA_DEV_MODE=true)"; \
        sleep infinity; \
    fi'
autostart=false
autorestart=true
priority=15
stdout_logfile=/workspace/log/nginx/nginx_access.log
stdout_logfile_format=%(ENV_LOGGING_FORMAT)s
stdout_logfile_maxbytes=5MB
stdout_logfile_backups=5
stderr_logfile=/workspace/log/nginx/nginx_error.log
stderr_logfile_format=%(ENV_LOGGING_FORMAT)s
stderr_logfile_maxbytes=5MB
stderr_logfile_backups=5
environment=VYRA_DEV_MODE="%(ENV_VYRA_DEV_MODE)s",ENABLE_FRONTEND_WEBSERVER="%(ENV_ENABLE_FRONTEND_WEBSERVER)s"

[program:log_rotation]
command=bash -c 'while true; do sleep 3600; /opt/vyra/rotate_logs.sh /workspace/log/ros2/*_runtime.log 50 5; done'
directory=/workspace
autostart=true
autorestart=true
priority=20
stdout_logfile=/dev/null
stderr_logfile=/dev/null