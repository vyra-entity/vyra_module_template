name: Build and Publish Docker Image

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Load Module Configuration from .env
        id: module_config
        run: |
          # Extract MODULE_NAME from .env
          MODULE_NAME=$(grep -E '^MODULE_NAME=' .env | cut -d'=' -f2 | tr -d ' \r\n' | sed 's/#.*//')
          if [ -z "$MODULE_NAME" ]; then
            echo "ERROR: MODULE_NAME not found in .env"
            exit 1
          fi
          echo "module_name=${MODULE_NAME}" >> $GITHUB_OUTPUT
          echo "âœ… Module Name: ${MODULE_NAME}"
          
          # Extract GitHub organization from repository
          GITHUB_ORG=$(echo "${{ github.repository }}" | cut -d'/' -f1 | tr '[:upper:]' '[:lower:]')
          echo "github_org=${GITHUB_ORG}" >> $GITHUB_OUTPUT
          echo "âœ… GitHub Org: ${GITHUB_ORG}"
          
          # Construct full image name
          FULL_IMAGE_NAME="${{ env.REGISTRY }}/${GITHUB_ORG}/${MODULE_NAME}"
          echo "full_image_name=${FULL_IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "âœ… Full Image Name: ${FULL_IMAGE_NAME}"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
      
      - name: Build vyra_base_image dev
        run: |
          docker build --target development -t vyra_base_image:dev vyra_base_image/
          
      - name: Build vyra_base_image prod
        run: |
          docker build --target production -t vyra_base_image:prod vyra_base_image/
        
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.module_config.outputs.full_image_name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            
      - name: Build Builder Stage
        run: |
          docker build --target builder -t temp-builder .
          
      - name: Extract SROS2 CA Public Certificate
        run: |
          docker create --name temp-container temp-builder
          docker cp temp-container:/build/sros2_ca_public.pem ./sros2_ca_public.pem
          docker rm temp-container
          echo "CA Certificate extracted successfully"
          cat sros2_ca_public.pem
          
      - name: Upload SROS2 CA Certificate as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sros2-ca-certificate
          path: sros2_ca_public.pem
          retention-days: 90
          
      - name: Display CA Certificate Info
        run: |
          echo "âœ… SROS2 CA certificate extracted successfully"
          echo ""
          echo "ðŸ“‹ To use this certificate in other modules:"
          echo "1. Download from: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "2. Or add to GitHub Secrets manually:"
          echo "   Name: SROS2_CA_PUBLIC_CERT"
          echo "   Value (base64):"
          base64 -w 0 sros2_ca_public.pem
          echo ""
          
      - name: Build and Push Runtime Image
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
          MODULE_NAME: ${{ steps.module_config.outputs.module_name }}
          FULL_IMAGE_NAME: ${{ steps.module_config.outputs.full_image_name }}
        run: |
          # Build with module name as build arg
          docker build --target runtime \
            --build-arg MODULE_NAME="${MODULE_NAME}" \
            -t "${FULL_IMAGE_NAME}:latest" .
          
          # Push latest tag
          docker push "${FULL_IMAGE_NAME}:latest"
          
          # Tag and push all metadata tags
          echo "$TAGS" | while read -r tag; do
            if [ -n "$tag" ] && [ "$tag" != "${FULL_IMAGE_NAME}:latest" ]; then
              docker tag "${FULL_IMAGE_NAME}:latest" "$tag"
              docker push "$tag"
            fi
          done
            
      - name: Generate SBOM (Software Bill of Materials)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.module_config.outputs.full_image_name }}:latest
          format: spdx-json
          output-file: sbom.spdx.json
          
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 90
          
      - name: Image Summary
        env:
          MODULE_NAME: ${{ steps.module_config.outputs.module_name }}
          FULL_IMAGE_NAME: ${{ steps.module_config.outputs.full_image_name }}
        run: |
          echo "## ðŸš€ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Module:** \`${MODULE_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`${{ env.REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${FULL_IMAGE_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${FULL_IMAGE_NAME}:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SROS2 Certificate" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CA certificate extracted and stored as artifact" >> $GITHUB_STEP_SUMMARY
